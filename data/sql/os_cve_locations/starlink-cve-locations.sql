WITH cve_flags AS (
    SELECT host_ip, 1 AS has_cve
    FROM `ece-239as-project.starlink.starlink_cve_map`
    GROUP BY host_ip
),

host_labels AS (
  SELECT 
      h.location.country AS country,
      h.location.country_code AS country_code,
      COALESCE(c.has_cve, 0) AS has_cve
  FROM `ece239as-455719.censys.20250407_starlink` h
  LEFT JOIN cve_flags c
      ON h.host_identifier.ipv4 = c.host_ip
)

SELECT
  ANY_VALUE(country) AS country,
  country_code,
  SUM(has_cve) AS hosts_with_cve,
  COUNT(*) AS host_count,
  ROUND(SUM(has_cve) * 100.0 / COUNT(*), 2) AS percentage_with_cve,
FROM host_labels
GROUP BY country_code
ORDER BY percentage_with_cve DESC
